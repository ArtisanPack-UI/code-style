# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence

stages:
  - test
  - release # Add a new 'release' stage

sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml

create_release:
  stage: release
  image: alpine:latest # Changed to a more generic alpine image to ensure basic utilities are available
  before_script:
    # Install necessary tools: grep, sed, bash (for advanced shell features if needed), and curl
    # apk is Alpine's package manager. --no-cache speeds up the installation.
    - apk add --no-cache grep sed bash curl
    # Download and install release-cli.
    # The --location flag follows redirects.
    # The --output flag specifies the output file path.
    - curl --location --output /usr/local/bin/release-cli "https://gitlab.com/gitlab-org/release-cli/-/releases/permalink/latest/downloads/release-cli-linux-amd64"
    # Make the downloaded binary executable.
    - chmod +x /usr/local/bin/release-cli
  rules:
    - if: $CI_COMMIT_TAG # This job will only run when a Git tag is pushed
  script:
    # Extract the version number from the Git tag (e.g., 'v1.2.3' -> '1.2.3')
    - RELEASE_VERSION=$(echo "$CI_COMMIT_TAG" | sed 's/^v//')

    # Define markers for the start and end of the desired section in CHANGELOG.md
    # Assumes CHANGELOG.md headings are like '## [X.Y.Z]'
    - START_MARKER="## \\[${RELEASE_VERSION}\\]"
    - END_MARKER="## \\[[0-9]*\\.[0-9]*\\.[0-9]*\\]" # Matches the next version heading

    # Extract the block of text for the current release from CHANGELOG.md
    # Using sed to get content between the current tag's heading and the next heading
    # -n suppresses automatic printing, /pattern1/,/pattern2/p prints lines from pattern1 to pattern2.
    - CHANGELOG_CONTENT=$(sed -n "/$START_MARKER/,/$END_MARKER/p" CHANGELOG.md)

    # Clean up the extracted content:
    # 1. Remove the current version heading itself using grep -v (invert match).
    # 2. Remove the next version heading (if it was included in the sed output) using grep -v.
    # 3. Remove the "# Changelog" title if present using grep -v.
    # 4. Remove leading/trailing whitespace and empty lines using sed -e commands.
    - RELEASE_DESCRIPTION=$(echo "$CHANGELOG_CONTENT" | \
      grep -v "$START_MARKER" | \
      grep -v "$END_MARKER" | \
      grep -v "^# Changelog" | \
      sed -e 's/^[[:space:]]*//' -e '/^$/d')

    # Fallback description if the specific version isn't found in CHANGELOG.md or is empty
    - |
      if [ -z "$RELEASE_DESCRIPTION" ]; then
        echo "Warning: Could not find a specific description for tag $CI_COMMIT_TAG in CHANGELOG.md. Using a generic description."
        RELEASE_DESCRIPTION="Release $CI_COMMIT_TAG. Refer to CHANGELOG.md for detailed changes."
      fi

    # Create the release using release-cli
    # The --name argument sets the release title, often the same as the tag
    # The --tag-name argument specifies which tag this release is associated with
    # The --description argument uses the content extracted from CHANGELOG.md
    - release-cli create --name "Release $CI_COMMIT_TAG" --tag-name "$CI_COMMIT_TAG" --description "$RELEASE_DESCRIPTION"
