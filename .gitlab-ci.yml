# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence

stages:
  - test
  - release # Add a new 'release' stage

sast:
  stage: test
include:
  - template: Security/SAST.gitlab-ci.yml

create_release:
  stage: release
  image: alpine:latest # Changed to a more generic alpine image to ensure basic utilities are available
  before_script:
    # Install necessary tools: grep, sed, bash (for advanced shell features if needed), and curl
    # apk is Alpine's package manager. --no-cache speeds up the installation.
    - apk add --no-cache grep sed bash curl
    # Download and install release-cli.
    # IMPORTANT: Changed to a specific version URL (v0.16.0) instead of 'permalink/latest'
    # to ensure the binary is downloaded directly and not an HTML redirect.
    - curl --location --output /usr/local/bin/release-cli "https://gitlab.com/gitlab-org/release-cli/-/releases/v0.16.0/downloads/release-cli-linux-amd64"
    # Make the downloaded binary executable.
    - chmod +x /usr/local/bin/release-cli
    # Verify that the release-cli is executable and get its version
    - echo "Verifying release-cli installation:"
    - /usr/local/bin/release-cli --version
  rules:
    - if: $CI_COMMIT_TAG # This job will only run when a Git tag is pushed
  script:
    # Wrap the entire script in 'bash -c' to ensure all commands are executed by bash.
    # Variables that depend on $CI_COMMIT_TAG must be defined inside this block
    # so they are correctly expanded by the inner bash shell.
    # Add 'set -euxo pipefail' for verbose debugging and immediate exit on errors.
    - |
      bash -c '
        set -euxo pipefail # Enable debugging flags for debugging

        echo "--- Debugging Release Script ---"
        echo "CI_COMMIT_TAG: ${CI_COMMIT_TAG}"

        # Ensure CI_JOB_TOKEN is available for release-cli authentication
        if [ -z "${CI_JOB_TOKEN}" ]; then
          echo "Error: CI_JOB_TOKEN is not available. Release CLI needs this for authentication."
          exit 1
        fi
        echo "CI_JOB_TOKEN is available."

        # Verify CHANGELOG.md exists in the current working directory
        echo "Listing files in current directory ($(pwd)):"
        ls -la
        if [ ! -f "CHANGELOG.md" ]; then
          echo "Error: CHANGELOG.md not found in the repository root. Cannot extract release description."
          RELEASE_DESCRIPTION="Release ${CI_COMMIT_TAG}. No CHANGELOG.md found. Please create one."
          # Continue to create a basic release even if CHANGELOG.md is missing
          /usr/local/bin/release-cli create --name "Release ${CI_COMMIT_TAG}" --tag-name "${CI_COMMIT_TAG}" --description "${RELEASE_DESCRIPTION}"
          echo "Basic release created due to missing CHANGELOG.md."
          exit 0 # Exit successfully after creating a basic release
        fi

        echo "CHANGELOG.md found. Attempting to read content."
        echo "--- Start of CHANGELOG.md Content ---"
        cat CHANGELOG.md
        echo "--- End of CHANGELOG.md Content ---"

        # Extract the version number from the Git tag (e.g., 'v1.2.3' -> '1.2.3')
        RELEASE_VERSION=$(echo "${CI_COMMIT_TAG}" | sed 's/^v//')
        echo "Extracted RELEASE_VERSION: ${RELEASE_VERSION}"

        # Define markers for the start and end of the desired section in CHANGELOG.md
        START_MARKER="## \\[${RELEASE_VERSION}\\]"
        END_MARKER="## \\[[0-9]*\\.[0-9]*\\.[0-9]*\\]" # Matches the next version heading
        echo "START_MARKER: ${START_MARKER}"
        echo "END_MARKER: ${END_MARKER}"

        # Extract the block of text for the current release from CHANGELOG.md
        CHANGELOG_CONTENT=$(sed -n "/${START_MARKER}/,/${END_MARKER}/p" CHANGELOG.md)
        echo "Raw CHANGELOG_CONTENT extracted (may be empty if no match):"
        echo "${CHANGELOG_CONTENT}"

        # Clean up the extracted content:
        # Check if CHANGELOG_CONTENT is empty before piping to grep/sed to avoid errors
        if [ -z "${CHANGELOG_CONTENT}" ]; then
          RELEASE_DESCRIPTION="" # Set to empty if no content extracted
        else
          RELEASE_DESCRIPTION=$(echo "${CHANGELOG_CONTENT}" | \
            grep -v "${START_MARKER}" | \
            grep -v "${END_MARKER}" | \
            grep -v "^# Changelog" | \
            sed -e 's/^[[:space:]]*//' -e '/^$/d')
        fi

        # Fallback description if the specific version isn''t found or extraction failed
        if [ -z "${RELEASE_DESCRIPTION}" ] || [ "${RELEASE_DESCRIPTION}" = " " ]; then
          echo "Warning: Could not find a specific description for tag ${CI_COMMIT_TAG} in CHANGELOG.md or extracted content was empty/whitespace. Using a generic description."
          RELEASE_DESCRIPTION="Release ${CI_COMMIT_TAG}. Refer to CHANGELOG.md for detailed changes."
        fi

        echo "--- Final Release Description Content to be Used ---"
        echo "${RELEASE_DESCRIPTION}"
        echo "----------------------------------------------------"

        echo "Attempting to create release with release-cli..."
        # Explicitly call release-cli with its full path for safety, though it should be in PATH
        /usr/local/bin/release-cli create --name "Release ${CI_COMMIT_TAG}" --tag-name "${CI_COMMIT_TAG}" --description "${RELEASE_DESCRIPTION}"
        echo "Release-cli command executed successfully."
      '
